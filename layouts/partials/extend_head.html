<!--
    A number stepper as used on potvik.com

    Features include
    - minimum & maximum values
    - configurable step size
    - keyboard input
    - all kinds of transitions

    Design by Orians Anvari
-->

<style>
    @import url("https://fonts.googleapis.com/css?family=Rubik&display=swap");

:root {
    --color-black: #112c34;
    --color-blue-dark: #65849a;
    --color-mustard-light: #ede6d9;
    --color-mustard-extra-light: #fcf9ed;
    --color-mustard-midtone: #9c7830;
}

#prayer-section {
    width: 100%;
    display: block;
    direction: rtl;
}

.black {
    color:black;
}

form {
    direction: ltr;
    right: 0;
    width: 100%;
    max-width: 340px;

    padding: 56px 48px;

    border-radius: 40px;

    box-shadow: 0px 8px 40px rgba(128, 128, 128, 0.15);

    display: block;
    /* flex-direction: column; */
    align-items: center;

    background-color: #fffef9;
}

form > div {
    margin-bottom: 32px;
}

form > div:last-child {
    margin-bottom: 0;
}

.number-input-container {
    width: 244px;

    display: grid;
    grid-template-columns: 48px auto 48px;
}

label {
    display: inline-block;

    margin-bottom: 4px;

    font-size: 12px;
    line-height: 24px;

    letter-spacing: 2px;
    text-transform: uppercase;

    color: var(--color-blue-dark);
}

.number-input {
    width: 100%;

    display: flex;
    flex-direction: row;

    background-color: var(--color-mustard-extra-light);

    overflow: hidden;
}

input[type="number"] {
    -webkit-appearance: none;
    -webkit-border-radius: 0px;
    -moz-appearance: none;
    appearance: none;

    position: relative;

    width: 100%;
    min-width: 100%;
    height: 48px;

    background-color: var(--color-mustard-extra-light);

    border: 1px solid var(--color-mustard-light);
    border-left: 1px solid rgba(0, 0, 0, 0);
    border-right: 1px solid rgba(0, 0, 0, 0);
    border-radius: none;

    font-size: 16px;
    line-height: 24px;
    text-align: center;

    transition: all 0.2s ease-out;
}

input[type="number"]:focus {
    background-color: white;

    border: 1px solid var(--color-mustard-midtone);

    outline: none;
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}

#prayer-section button {
    position: relative;

    height: 100%;

    margin-top: 32px;
    padding: 12px 16px;

    background-color: var(--color-mustard-extra-light);

    border: 1px solid var(--color-mustard-light);
    border-radius: none;

    transition: all 0.1s ease-out;

    cursor: pointer;

    -webkit-appearance: none;

    -webkit-transform: scale(1);
    transform: scale(1);
}

#prayer-section button {
    margin: 0;

    color: var(--color-black);
}

#prayer-section button:active,
button:focus {
    outline: none;
}

#prayer-section button::after {
    content: "";

    position: absolute;

    opacity: 1;

    top: 0;
    left: 0;
    bottom: 0;
    right: 0;

    transition: inherit;

    background-position: center;
    background-repeat: no-repeat;
}

#prayer-section button:disabled {
    pointer-events: none;
}

#prayer-section button:disabled::after {
    opacity: 0.25;
}

#prayer-section .button-decrement::after {
    background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 12H7' stroke='%23112C34' stroke-width='2' stroke-miterlimit='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E%0A");
}

#prayer-section .button-increment::after {
    background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 7V17' stroke='%23112C34' stroke-width='2' stroke-miterlimit='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M17 12H7' stroke='%23112C34' stroke-width='2' stroke-miterlimit='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E%0A");
}

#prayer-section .button-decrement {
    border-right: none;
}

#prayer-section .button-increment {
    border-left: none;
}

@media (hover: hover) {
    input[type="number"]:hover,
    #prayer-section button:hover {
        background-color: white;
    }

    #prayer-section button:active {
        background-color: var(--color-mustard-extra-light);
        transform: translateY(1px);
    }
}

@media (hover: none) {
    #prayer-section button:active {
        background-color: white;
        transform: translateY(1px);
    }
}

</style>

<script>
    let prayerTally = 0;
    function init() {
    // enable active states for buttons in mobile safari
    document.addEventListener("touchstart", function () {}, false);
    updateTally();
    setInputButtonState();
}

function updateTally() {
    fetch('https://api.carrollmedia.dev/prayer')
  .then((response) => response.json())
  .then((data) => {
    prayerTally = data['prayer-tally']
    let tallyDisplay = document.getElementById('tally-display');
    tallyDisplay.innerText = prayerTally;
});
}

function addPrayerTime(event) {
const hue = document.getElementById('hue');
const minutes = hue.value;

fetch('https://api.carrollmedia.dev/prayer?minutes=' + minutes, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  }
})
  .then((response) => 
  {
    response.json();
    updateTally();
    })
  .then((data) => {
    console.log('Success:', data);
  })
  .catch((error) => {
    console.error('Error:', error);
  });

}

function handleNumberInput() {
    setInputButtonState();
}

function handleNumberInputBlur(event) {
    const value = event.target.value;

    if (event.target.hasAttribute("min") && value < parseFloat(event.target.min))
        event.target.value = event.target.min;

    if (event.target.hasAttribute("max") && value > parseFloat(event.target.max))
        event.target.value = event.target.max;
}

function setInputButtonState() {
    const inputs = document.getElementsByClassName("number-input-text-box");

    for (let input of inputs) {
        if (input.id.length > 0) { // during value transition the old input won't have an id
            const value = input.value;
            const parent = input.parentElement.parentElement;

            if (parent.children[0] && input.hasAttribute("min"))
                parent.children[0].disabled = value <= parseFloat(input.min);

            if (parent.children[2] && input.hasAttribute("max"))
                parent.children[2].disabled = value >= parseFloat(input.max);
        }
    }
}

function setNumber(event) {
    let button = event.target;
    let input = document.getElementById(button.dataset.inputId);

    if (input) {
        let value = parseFloat(input.value);
        let step = parseFloat(input.dataset.step);

        if (button.dataset.operation === "decrement") {
            value -= isNaN(step) ? 1 : step;
        } else if (button.dataset.operation === "increment") {
            value += isNaN(step) ? 1 : step;
        }

        if (input.hasAttribute("min") && value < parseFloat(input.min)) {
            value = input.min;
        }

        if (input.hasAttribute("max") && value > parseFloat(input.max)) {
            value = input.max;
        }

        if (input.value !== value) {
            setInputValue(input, value);
            setInputButtonState();
        }
    }
}

function setInputValue(input, value) {
    let newInput = input.cloneNode(true);
    const parentBox = input.parentElement.getBoundingClientRect();

    input.id = "";

    newInput.value = value;

    if (value > input.value) {
        // right to left
        input.parentElement.appendChild(newInput);
        input.style.marginLeft = -parentBox.width + "px";
    } else if (value < input.value) {
        // left to right
        newInput.style.marginLeft = -parentBox.width + "px";
        input.parentElement.prepend(newInput);
        window.setTimeout(function () {
            newInput.style.marginLeft = 0
        }, 20);
    }

    window.setTimeout(function () {
        input.parentElement.removeChild(input);
    }, 250);
}

window.onload = init;
</script>
<div id="prayer-section">
    <form action="javascript:void(0);">
        <div>
            <div>
                <p class="black">The current prayer tally is <span id="tally-display"></span> minutes</p>
            </div>
            <div>
                <label for="hue">Prayer minutes tally</label>
            </div>
            <div class="number-input-container">
                <button
                    type="button"
                    class="button-decrement"
                    onclick="setNumber(event)"
                    data-input-id="hue"
                    data-operation="decrement"
                ></button>
                <div class="number-input">
                    <input
                        type="number"
                        id="hue"
                        name="hue"
                        class="number-input-text-box"
                        value="0"
                        min="0"
                        max="360"
                        oninput="handleNumberInput()"
                        onblur="handleNumberInputBlur(event)"
                        data-step="5"
                    />
                </div>
                <button
                    type="button"
                    class="button-increment"
                    onclick="setNumber(event)"
                    data-input-id="hue"
                    data-operation="increment"
                ></button>
            </div>
            <button
                    type="button"
                    onclick="addPrayerTime(event)"
                >Add time</button>
        </div>
    </form>
</div>